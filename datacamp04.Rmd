---
title: "Data Manipulation with dplyr"
output: 
 html_document:
   toc: true
   toc_depth: 2
   number_sections: true
   toc_float: true
---

```{css, include=FALSE}
.badCode {
background-color: red;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Transforming Data with dplyr

## Exploring data with dplyr

```{r}
library(dplyr)
library(ggplot2)
counties <- readRDS(file = "datasets/counties.rds")
```
```{r}
glimpse(counties)

counties %>%
  # Select the columns
  select(state,county,population,poverty)
```

## The filter and arrange verbs

```{r}
counties_selected <- counties %>%
  select(state,county,population,unemployment,metro)

counties_selected

counties_selected %>%
  arrange(population)

counties_selected %>%
  arrange(desc(population))

counties_selected %>%
  arrange(desc(population)) %>%
  filter(state == "New York")

counties_selected %>%
  arrange(desc(population)) %>%
  filter(unemployment<6) #6%

counties_selected %>%
  arrange(desc(population)) %>%
  filter(state == "New York",unemployment<6)
```
## The mutate() verb

```{r}
counties_selected %>%
  mutate(unemployed_population = population*unemployment/100) %>%
  arrange(desc(unemployed_population))
```

# Aggregating Data

## The count verb

```{r}
counties %>%
  count()

counties %>%
  count(state)

counties %>%
  count(state, sort = TRUE)

counties %>%
  count(state, wt = population, sort = TRUE)
```
## The group_by, summarize, and ungroup verbs

```{r}
counties %>%
  summarize(total_pop = sum(population))

counties %>%
  group_by(state) %>%
  summarize(total_pop = sum(population),
            average_enemployment = mean(unemployment)) %>%
  arrange(desc(average_enemployment))

counties %>%
  group_by(state, metro) %>%
  summarize(total_pop = sum(population),
            average_enemployment = mean(unemployment)) %>%
  arrange(desc(average_enemployment))

counties %>%
  group_by(state, metro) %>%
  summarize(total_pop = sum(population),
            average_enemployment = mean(unemployment)) %>%
  arrange(desc(average_enemployment)) %>%
  ungroup()
```

## The slice_min and slice_max verbs

```{r}
counties_selected %>%
  group_by(state) %>%
  slice_max(population, n = 1)

counties_selected %>%
  group_by(state) %>%
  slice_min(unemployment, n = 1)

counties_selected %>%
  group_by(state) %>%
  slice_max(unemployment, n = 3)
```

```{r}
counties_selected %>%
  # Find the total population for each combination of state and metro
  group_by(state, metro) %>%
  summarize(total_pop = sum(population))

counties_selected %>%
  # Find the total population for each combination of state and metro
  group_by(state, metro) %>%
  summarize(total_pop = sum(population)) %>%
  # Extract the most populated row for each state
  slice_max(total_pop, n = 1)

counties_selected %>%
  # Find the total population for each combination of state and metro
  group_by(state, metro) %>%
  summarize(total_pop = sum(population)) %>%
  # Extract the most populated row for each state
  slice_max(total_pop, n = 1) %>%
  # Count the states with more people in Metro or Nonmetro areas
  ungroup()

counties_selected %>%
  # Find the total population for each combination of state and metro
  group_by(state, metro) %>%
  summarize(total_pop = sum(population)) %>%
  # Extract the most populated row for each state
  slice_max(total_pop, n = 1) %>%
  # Count the states with more people in Metro or Nonmetro areas
  ungroup() %>%
  count(metro)
```

# Selecting and Transforming Data

## Selecting

```{r}
counties %>%
  select(state, county, drive:work_at_home) %>%
  arrange(drive)

counties %>%
  select(state, county, contains("work"))

counties %>%
  select(state, county, starts_with("income"))
```

Other helpers: `contains()`, `starts_with()`, `ends_with()`, `last_col()`, `matches()`. ?select_helpers

```{r}
counties %>%
  select(-census_id)
```

## The rename verb

```{r}
counties_selected %>%
  rename(unemployment_rate = unemployment)

counties_selected %>%
  select(state,county,population, unemployment_rate = unemployment)
```

## The transmute verb

```{r}
counties %>%
  transmute(state, county, fraction_men = men / population)

counties %>%
  transmute(state, county, population, unemployed_people = population*unemployment / 100)
```

|                         | **keeps only specified variables** | **keeps other variables** |
|:-----------------------:|:----------------------------------:|:-------------------------:|
| **Can't change values** |               select               |           rename          |
|  **Can change values**  |              transmute             |           mutate          |

# Case Study: The babynames Dataset

## The babynames data

```{r}
babynames <- readRDS(file = "docs/datasets/babynames.rds")
```

```{r}
babynames %>%
  filter(name == "Arthur")

babynames_filtered <- babynames %>%
  filter(name == "Arthur")
```
```{r}
ggplot(babynames_filtered,aes(x = year, y = number)) +
  geom_line()
```

```{r}
babynames_multiple <- babynames %>%
  filter(name %in% c("Arthur", "Lucas")) #Lucas is my brother's name :) - I chose it lol
```
```{r}
babynames %>%
  # Find the most common name in each year
  group_by(year) %>%
  slice_max(number,n=1)
```

## Grouped mutates

```{r}
babynames %>%
  group_by(year) %>%
  summarise(year_total = sum(number))

babynames %>%
  group_by(year) %>%
  mutate(year_total = sum(number)) %>%
  ungroup() %>%
  mutate(fraction = number/year_total)
```
## Window functions

```{r}
v<-c(1,3,6,14)
v
lag(v)
v-lag(v)
```
Because by lining up each item in the vector with the item directly before it, we can compare consecutive steps and calculate the changes. With v minus lag(v), we're asking "What is each value once we've subtracted the previous one?"

```{r}
babynames_fraction <- babynames %>%
  group_by(year) %>%
  mutate(year_total = sum(number)) %>%
  ungroup() %>%
  mutate(fraction = number/year_total)

babynames_fraction %>%
  filter(name == "Arthur") %>%
  arrange(year)

babynames_fraction %>%
  filter(name == "Arthur") %>%
  arrange(year) %>%
  mutate(difference = fraction - lag(fraction))

babynames_fraction %>%
  filter(name == "Arthur") %>%
  arrange(year) %>%
  mutate(difference = fraction - lag(fraction)) %>%
  arrange(desc(difference))

babynames_fraction %>%
  arrange(name,year) %>%
  group_by(name) %>%
  mutate(difference = fraction - lag(fraction)) %>%
  ungroup() %>%
  arrange(desc(difference))
```



---
This code was last compiled at `r Sys.time()`